## Create operation

REST endpoint: `POST /v2/y-flows`

request payload:

```json
{
  "shared_endpoint": {
    "switch_id": "00:00:00:00:00:00:00:01",
    "port_number": 0
  },
  "maximum_bandwidth": 0,
  "path_computation_strategy": "strategy-name",
  "encapsulation_type": "encapsulation-name",
  "max_latency": 0,
  "max_latency_tier2": 0,
  "ignore_bandwidth": true,
  "periodic_pings": false,
  "pinned": false,
  "priority": 0,
  "strict_bandwidth": true,
  "description": "description",
  "allocate_protected_path": false,
  "diverse_flow_id": "diverse_flow_id",
  "sub_flows": [
    {
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "description": "description"
    },
    {
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "description": "description"
    }
  ]
} 
```

response payload (copy of request payload plus autogenerated fields):

```json
{
  "y_flow_id": "yf-AAAAAAAAAAAAAAA",
  "status": "IN_PROGRESS",
  "shared_endpoint": ...
  ... : ...,
  "y_point": null,
  "protected_path_y_point": null,
  "diverse_with_flows": [
    "diverse_flow"
  ],
  "diverse_with_y_flows": [
    "diverse_y_flow"
  ],
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    }
  ],
  "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
  "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
}
```

## Read operation

REST endpoint: `GET /v2/y-flows/{y_flow_id}`

response payload:

```json
{
  "y_flow_id": "yf-AAAAAAAAAAAAAAA",
  "status": "UP",
  "shared_endpoint": {
    "switch_id": "00:00:00:00:00:00:00:01",
    "port_number": 0
  },
  "maximum_bandwidth": 0,
  "path_computation_strategy": "strategy-name",
  "encapsulation_type": "encapsulation-name",
  "max_latency": 0,
  "max_latency_tier2": 0,
  "ignore_bandwidth": true,
  "periodic_pings": false,
  "pinned": false,
  "priority": 0,
  "strict_bandwidth": true,
  "description": "description",
  "allocate_protected_path": false,
  "y_point": "00:00:00:00:00:00:01:01",
  "protected_path_y_point": "00:00:00:00:00:00:02:02",
  "diverse_with_flows": [
    "diverse_flow"
  ],
  "diverse_with_y_flows": [
    "diverse_y_flow"
  ],
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    }
  ],
  "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
  "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
}
```

The `y_point` contains the switch_id on which the flow path split into two paths. I.e. from a "shared_endpoint" to a "y_point", all subordinate
flows have the same path. From "y_point" to each "endpoint" defined in "flows" array, flows have independent paths. In case a path
cannot be determined, the `y_point` is `null` (the y_flow status in this case can't be `UP`). `protected_path_y_point` is similar to `y_point`,
but for protected paths.

The `sub_flows` collection contains information about the "second" (not shared) endpoint of subordinate flows. It can contain 0 to 2 records.

The `status` is calculated using subordinate flow's statuses. It will `UP` if all subordinate flow statuses are `UP`. It will
be `DEGRADED` if any of the subordinate flow statuses is not `UP`. It will be `DOWN` if there is no any subordinate flow
in `UP` status or there is no any subordinate flow at all. At least one subordinate flow must be `UP` for a y_flow to start
passing traffic.

## Update operation

Changes will be propagated on all already existing subordinate flows.

REST endpoints: 
 * `PUT /v2/y-flows/{y_flow_id}`
 * `PATCH /v2/y-flows/{y_flow_id}`

Request/response bodies are the same as the create operation. In case of PATCH request, only fields present in the request body
will be updated.

## Reroute operation

Changes will be propagated on all already existing subordinate flows.

REST endpoint: `POST /v2/y-flows/{y_flow_id}/reroute`

Request body is ignored, response payload:

```json
{
  "rerouted": true,
  "shared_path": {
    "nodes": [
      {
        "port_no": 0,
        "segment_latency": 10,
        "switch_id": "00:00:00:00:00:00:00:04"
      }
    ]
  },
  "sub_flow_paths": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:05"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:06"
        }
      ]
    }
  ]
}
```

## Delete operation

REST endpoint: `DELETE /v2/y-flows/{y_flow_id}`

Request body is ignored, response body is the same as the read operation.

## Read subordinate flows

REST endpoint: `GET /v2/y-flows/{y_flow_id}/flows`

Response body:

```json
{
  "flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "shared_endpoint": {
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "status",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    }, {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": ...
    }
  ]
}
```

## Read paths

REST endpoint: `GET /v2/y-flows/{y_flow_id}/paths`

Response body:

```json
{
  "shared_path": {
    "nodes": [
      {
        "port_no": 0,
        "segment_latency": 0,
        "switch_id": "00:00:00:00:00:00:00:08"
      }
    ]
  },
  "sub_flow_paths": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:09"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:09"
        }
      ]
    }
  ]
}
```

## Ping operation

REST endpoint: `POST /v2/y-flows/{y_flow_id}/ping`

request payload:

```json
{
  "timeout": 0
} 
```

response payload:

```json
{
  "y_flow_id": "yf-AAAAAAAAAAAAAAA",
  "ping_success": true,
  "error": "error",
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "forward": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      },
      "reverse": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      }
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "forward": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      },
      "reverse": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      }
    }
  ]
}
```

## Validate operation

REST endpoint: `POST /v2/y-flows/{y_flow_id}/validate`

Request body is ignored, response payload:

```json
{
  "as_expected": true,
  "y_flow_validation_result": {
    "as_expected": true,
    "discrepancies": [
      {
        "actual_value": "string",
        "expected_value": "string",
        "field": "string",
        "rule": "string"
      }
    ]
  },
  "sub_flow_validation_results": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "as_expected": true,
      "discrepancies": [
        {
          "actual_value": "string",
          "expected_value": "string",
          "field": "string",
          "rule": "string"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "as_expected": true,
      "discrepancies": [
        {
          "actual_value": "string",
          "expected_value": "string",
          "field": "string",
          "rule": "string"
        }
      ]
    }
  ]
}
```

## Paths swap operation

REST endpoint: `POST /v2/y-flows/{y_flow_id}/swap`

Request body is ignored, response body is the same as the create/update operations.

# Existing API changes

All flows CRUD operation responses will be extended with the following fields:

```json
{
  "...": "...",
  "y_flow_id": "yf-AAAAAAAAAAAAAAA",
  "....": "..."
}
```

The `y_flow_id` must be non-null if the flow is a subordinate flow of some y_flow.

The following operations must be rejected for y-flow subordinate flows requested via:

* `PUT /v1/flows/{flow_id}`
* `PUT /v2/flows/{flow_id}`
* `PATCH /v1/flows/{flow_id}`
* `PATCH /v2/flows/{flow_id}`
* `PATCH /v1/flows/{flow_id}/swap`
* `PATCH /v1/flows/{flow_id}/meters`
* `POST /v1/flows/{flow_id}/reroute`
* `POST /v2/flows/{flow_id}/reroute`
* `DELETE /v1/flows`
* `DELETE /v1/flows/{flow_id}`
* `DELETE /v2/flows/{flow_id}`
* `POST /v2/flows/swap-endpoint`
* `POST /v2/flows/{flow_id}/loops`
