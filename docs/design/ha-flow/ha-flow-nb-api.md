## Create operation

REST endpoint: `POST /v2/ha-flows`

request payload:

```json
{
  "ha_flow_id": "haf-AAAAAAAAAAAAAAA",
  "shared_endpoint": {
    "switch_id": "00:00:00:00:00:00:00:01",
    "port_number": 0,
    "vlan_id": 0,
    "inner_vlan_id": 0
  },
  "maximum_bandwidth": 0,
  "path_computation_strategy": "strategy-name",
  "encapsulation_type": "encapsulation-name",
  "max_latency": 0,
  "max_latency_tier2": 0,
  "ignore_bandwidth": true,
  "periodic_pings": false,
  "pinned": false,
  "priority": 0,
  "strict_bandwidth": true,
  "description": "description",
  "allocate_protected_path": false,
  "diverse_flow_id": "diverse_flow_id",
  "sub_flows": [
    {
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "description": "description"
    },
    {
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "description": "description"
    }
  ]
} 
```

response payload (copy of request payload plus autogenerated fields):

```json
{
  "ha_flow_id": "haf-AAAAAAAAAAAAAAA",
  "status": "IN_PROGRESS",
  "shared_endpoint": ...
  ... : ...,
  "diverse_with_flows": [
    "diverse_flow"
  ],
  "diverse_with_y_flows": [
    "diverse_y_flow"
  ],
  "diverse_with_ha_flows": [
    "diverse_ha_flow"
  ],
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    }
  ],
  "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
  "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
}
```

As you can see there are no sub flow fields `flow_id` in request body, but response contains these fields.
`flow_id` field will be generated by controller, based on `ha_flow_id` using following pattern:
* `flow_id` for the first subflow will be `{ha_flow_id}-a` (as A-end)
* `flow_id` for the second subflow will be `{ha_flow_id}-b` (as B-end)

Also, user can't update `flow_id` fields.

## Read operation

REST endpoint: `GET /v2/ha-flows/{ha_flow_id}`

response payload:

```json
{
  "ha_flow_id": "haf-AAAAAAAAAAAAAAA",
  "status": "UP",
  "shared_endpoint": {
    "switch_id": "00:00:00:00:00:00:00:01",
    "port_number": 0,
    "vlan_id": 0,
    "inner_vlan_id": 0
  },
  "maximum_bandwidth": 0,
  "path_computation_strategy": "strategy-name",
  "encapsulation_type": "encapsulation-name",
  "max_latency": 0,
  "max_latency_tier2": 0,
  "ignore_bandwidth": true,
  "periodic_pings": false,
  "pinned": false,
  "priority": 0,
  "strict_bandwidth": true,
  "description": "description",
  "allocate_protected_path": false,
  "diverse_with_flows": [
    "diverse_flow"
  ], 
  "diverse_with_y_flows": [
    "diverse_y_flow"
  ],
  "diverse_with_ha_flows": [
    "diverse_ha_flow"
  ],
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:02",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "endpoint": {
        "switch_id": "00:00:00:00:00:00:00:03",
        "port_number": 0,
        "vlan_id": 0,
        "inner_vlan_id": 0
      },
      "status": "IN_PROGRESS",
      "description": "description",
      "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
      "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]"
    }
  ],
  "time_create": "YYYY-MM-DDThh:mm:ss[.SSS]",
  "time_update": "YYYY-MM-DDThh:mm:ss[.SSS]",
}
```

`sub_flows` contain info about A-end and B-end endpoints. It can contain 2 records.

`status` calculated same way as common flow.
It will `UP` if all segments of HA-flow are `UP`. 

It will be `DEGRADED` in one of following cases:
1. Primary path is `UP`, but protected path is `DOWN`/`DEGRADED`.
2. * HA-flow has path computation strategy 'MAX_LATENCY'
   * and primary or protected path doesn't fit into max_latency requirements
   * but fit into non-zero max_latency_tier2 requirements

It will be `DOWN` in one of following cases:
1. Any path segment is `DOWN`
2. * HA-flow has path computation strategy 'MAX_LATENCY'
   * and primary or protected path doesn't fit into max_latency requirements
   * and max_latency_tier2 is equal to 0/null.
3. * HA-flow has path computation strategy 'MAX_LATENCY'
   * and primary or protected path doesn't fit into max_latency_tier2 requirements.

## Update operation

REST endpoints: 
 * `PUT /v2/ha-flows/{ha_flow_id}`
 * `PATCH /v2/ha-flows/{ha_flow_id}`

Request/response bodies are the same to the create operation. In case of PATCH request
only present in request body fields will be updated.

## Reroute operation

REST endpoint: `POST /v2/ha-flows/{ha_flow_id}/reroute`

Request body is ignored, response payload:

```json
{
  "rerouted": true,
  "shared_path": {
    "nodes": [
      {
        "port_no": 0,
        "segment_latency": 10,
        "switch_id": "00:00:00:00:00:00:00:04"
      }
    ]
  },
  "sub_flow_paths": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:05"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:06"
        }
      ]
    }
  ]
}
```

## Delete operation

REST endpoint: `DELETE /v2/ha-flows/{ha_flow_id}`

Request body is ignored, response body is the same to the read operation.

## Read paths

REST endpoint: `GET /v2/ha-flows/{ha_flow_id}/paths`

Response body:

```json
{
  "shared_path": {
    "nodes": [
      {
        "port_no": 0,
        "segment_latency": 0,
        "switch_id": "00:00:00:00:00:00:00:08"
      }
    ]
  },
  "sub_flow_paths": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:09"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "nodes": [
        {
          "port_no": 0,
          "segment_latency": 0,
          "switch_id": "00:00:00:00:00:00:00:09"
        }
      ]
    }
  ]
}
```

## Ping operation

REST endpoint: `POST /v2/ha-flows/{ha_flow_id}/ping`

request payload:

```json
{
  "timeout": 0
} 
```

response payload:

```json
{
  "ha_flow_id": "haf-AAAAAAAAAAAAAAA",
  "ping_success": true,
  "error": "error",
  "sub_flows": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "forward": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      },
      "reverse": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      }
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "forward": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      },
      "reverse": {
        "ping_success": true,
        "error": "error",
        "latency": 0
      }
    }
  ]
}
```

## Validate operation

REST endpoint: `POST /v2/ha-flows/{ha_flow_id}/validate`

Request body is ignored, response payload:

```json
{
  "as_expected": true,
  "ha_flow_validation_result": {
    "as_expected": true,
    "discrepancies": [
      {
        "actual_value": "string",
        "expected_value": "string",
        "field": "string",
        "rule": "string"
      }
    ]
  },
  "sub_flow_validation_results": [
    {
      "flow_id": "fAAAAAAAAAAAAAAA",
      "as_expected": true,
      "discrepancies": [
        {
          "actual_value": "string",
          "expected_value": "string",
          "field": "string",
          "rule": "string"
        }
      ]
    },
    {
      "flow_id": "fAAAAAAAAAAAAAAB",
      "as_expected": true,
      "discrepancies": [
        {
          "actual_value": "string",
          "expected_value": "string",
          "field": "string",
          "rule": "string"
        }
      ]
    }
  ]
}
```

## Paths swap operation

REST endpoint: `POST /v2/ha-flows/{ha_flow_id}/swap`

Request body is ignored, response body is the same to the create/update operations.

# Existing API changes

All flows CRUD operation responses will be extended with following field:

```json
{
  "...": "...",
  "diverse_with_ha_flows": ["haf-AAAAAAAAAA", "haf-BBBBBBBBBB"],
  "....": "..."
}
```
