Internal data
* ISL reference
* BFD descriptor
* linkStatus (initial false)
* action

Internal signals
* fail

Input signals
* online
* offline
* port-up
* port-down
* enable (ISL-FSM)
* disable (ISL-FSM)
* speaker-response
* action-success
* action-fail

Output signals
* bfd-up
* bfd-down
* bfd-kill

@startuml bfd-port-FSM
title BFD port FSM

[*] --> INIT

state initChoice <<choice>>
INIT --> initChoice : history / load persistence-data

initChoice --> IDLE : [else]
initChoice --> INIT_REMOVE : [BFD-discriminator is set]

IDLE --> INIT_SETUP : enable / save ISL reference
IDLE --> CONFLICT : port-up
IDLE --> UNOPERATIONAL : offline
IDLE : enter / report ready to setup

UNOPERATIONAL --> IDLE : online
UNOPERATIONAL --> PENDING : enable

CONFLICT --> IDLE : port-down
CONFLICT --> UNOPERATIONAL : offline
CONFLICT : enter / report conflict
CONFLICT : enable / report conflict
CONFLICT : disable / report conflict

PENDING --> UNOPERATIONAL : disable
PENDING --> INIT_SETUP : port-down
PENDING --> CONFLICT : port-up
PENDING : enter / save ISL reference

INIT_SETUP --> IDLE : fail
INIT_SETUP --> DO_SETUP : next
INIT_SETUP : enter / allocate BFD-discriminator

DO_SETUP --> ACTIVE : action-success
DO_SETUP --> INIT_REMOVE : disable
DO_SETUP --> SETUP_FAIL : action-fail / report error
DO_SETUP --> SETUP_INTERRUPT : offline
DO_SETUP --> INIT_CLEANUP : kill
DO_SETUP : enter / make BFD-setup action
DO_SETUP : speaker-response / proxy to action
DO_SETUP : port-up / proxy to action
DO_SETUP : port-down / proxy to action

DO_REMOVE --> IDLE : action-success / release BFD-descriptor
DO_REMOVE --> REMOVE_FAIL : action-fail / report error
DO_REMOVE --> REMOVE_INTERRUPT : offline\nonline
DO_REMOVE --> DO_CLEANUP : kill
DO_REMOVE --> RESETUP : enable
DO_REMOVE : speaker-response / proxy to action
DO_REMOVE : port-up / proxy to action
DO_REMOVE : port-down / proxy to action

state ACTIVE {
    [*] --> UP

    UP -r-> DOWN : port-down
    UP --> OFFLINE : offline
    UP : enter / emit bfd-up
    UP : enter / set linkStatus = UP

    DOWN -l-> UP : port-up
    DOWN --> OFFLINE : offline
    DOWN : enter / emit bfd-down
    DOWN : enter / set linkStatus = DOWN

    OFFLINE --> UP : port-up
    OFFLINE --> DOWN : port-down
    OFFLINE : enter / emit bfd-kill
}
ACTIVE --> INIT_REMOVE : disable
ACTIVE --> INIT_CLEANUP : kill
ACTIVE : enter / report setup complete
ACTIVE : exit / emit bfd-kill

INIT_REMOVE : enter / make BFD-remove action
INIT_REMOVE --> DO_REMOVE : next

INIT_CLEANUP --> DO_CLEANUP : next
INIT_CLEANUP : enter / make BFD-remove action

DO_CLEANUP --> [*] : action-success / release BFD-descriptor\naction-fail / report error
DO_CLEANUP : enter / action.updateLinkStatus(DOWN)
DO_CLEANUP : speaker-response / proxy to action

SETUP_INTERRUPT --> SETUP_RECOVERY : online
SETUP_INTERRUPT --> REMOVE_INTERRUPT : disable

SETUP_FAIL --> INIT_REMOVE : disable
SETUP_FAIL --> SETUP_INTERRUPT : offline
SETUP_FAIL : enable / report malfunction

REMOVE_FAIL --> INIT_REMOVE : disable
REMOVE_FAIL --> RESETUP_RECOVERY: enable
REMOVE_FAIL --> REMOVE_INTERRUPT : offline\nonline

REMOVE_INTERRUPT --> INIT_REMOVE : port-up / set linkStatus = UP\nport-down / set linkStatus DOWN
REMOVE_INTERRUPT --> RESETUP_INTERRUPT : enable

RESETUP --> INIT_SETUP : action-success / release BFD-descriptor
RESETUP --> RESETUP_FAIL : action-fail / report error
RESETUP --> DO_REMOVE : disable
RESETUP --> RESETUP_INTERRUPT : offline\nonline
RESETUP : speaker-response / proxy to action
RESETUP : port-up / proxy to action
RESETUP : port-down / proxy to action

SETUP_RECOVERY --> DO_SETUP : action-success
SETUP_RECOVERY --> SETUP_INTERRUPT : offline
SETUP_RECOVERY --> SETUP_FAIL : action-fail / report error
SETUP_RECOVERY --> DO_REMOVE : disable
SETUP_RECOVERY : enter / make BFD-remove action
SETUP_RECOVERY : speaker-response / proxy to action
SETUP_RECOVERY : port-up / proxy to action
SETUP_RECOVERY : port-down / proxy to action

RESETUP_FAIL --> RESETUP_INTERRUPT : offline\nonline
RESETUP_FAIL --> REMOVE_FAIL : disable

RESETUP_INTERRUPT --> RESETUP_RECOVERY : port-up / set linkStatus = UP\nport-down / set linkStatus DOWN
RESETUP_INTERRUPT --> REMOVE_INTERRUPT : disable

RESETUP_RECOVERY --> RESETUP : next
RESETUP_RECOVERY : enter / make BFD-remove action

@enduml
