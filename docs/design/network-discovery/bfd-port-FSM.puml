Internal data
* ISL reference
* BFD descriptor
* linkStatus (initial false)
* action

Internal signals
* fail

Input signals
* online
* offline
* port-up
* port-down
* enable (ISL-FSM)
* disable (ISL-FSM)
* speaker-response
* action-success
* action-fail

Output signals
* bfd-up
* bfd-down
* bfd-kill

@startuml
[*] --> INIT

INIT --> PENDING : port_add
INIT --> PORT_ADD : enable

PENDING --> SETUP : enable / save ISL-ref
PENDING --> OFFLINE : offline
PENDING --> PORT_REMOVE : disable

'there is no online/offline event until we have a port
PORT_ADD --> PORT_REMOVE : disable
PORT_ADD --> PORT_ADD_FAIL : grpc-error
PORT_ADD --> SETUP : port-add
PORT_ADD : enter / save ISL-ref
PORT_ADD : enter / emit create-logical-port

PORT_REMOVE --> [*] : grpc-ok
PORT_REMOVE --> PORT_ADD : enable
PORT_REMOVE --> PORT_REMOVE_OFFLINE : offline
PORT_REMOVE : enter / emit remove-logical-port

PORT_REMOVE_OFFLINE --> PORT_REMOVE : online
PORT_REMOVE_OFFLINE --> SETUP_OFFLINE : enable

'retry attempt?
PORT_ADD_FAIL --> [*] : disable
PORT_ADD_FAIL --> PORT_ADD : enable
PORT_ADD_FAIL --> SETUP : port-add

OFFLINE --> PENDING : online
OFFLINE --> SETUP_OFFLINE : enable
OFFLINE --> PORT_REMOVE_OFFLINE : disable

state SETUP {
    state busyChoice <<choice>>

    [*] --> busyChoice

    busyChoice -> RESOURCE_ALLOCATE : [clean]
    busyChoice -> SESSION_CLEANUP : [dirty]

    SESSION_CLEANUP -u-> RESOURCE_ALLOCATE : speaker-ok / release BFD-discriminator
    SESSION_CLEANUP -> SETUP_FAIL : speaker-fail
    SESSION_CLEANUP : enter / emit bfd-session remove

    RESOURCE_ALLOCATE -u-> SESSION_SETUP : next
    RESOURCE_ALLOCATE --> SETUP_FAIL : fail
    RESOURCE_ALLOCATE : enter / allocate BFD-discriminator

    SESSION_SETUP --> OPERATIONAL : speaker-ok
    SESSION_SETUP --> SETUP_FAIL : speaker-fail
    SESSION_SETUP : enter / emit bfd-session setup
}
SETUP --> SETUP_OFFLINE : offline
SETUP --> TEARDOWN : disable
SETUP : enter / load persistent-data

SETUP_OFFLINE --> SETUP : online
SETUP_OFFLINE --> TEARDOWN_OFFLINE : disable
SETUP_OFFLINE : enter / [on enable] save ISL-ref

TEARDOWN_OFFLINE --> TEARDOWN : online
TEARDOWN_OFFLINE --> SETUP_OFFLINE : enable

TEARDOWN --> PORT_REMOVE : speaker-ok / release BFD-discriminator
TEARDOWN --> TEARDOWN_FAIL : speaker-fail
TEARDOWN --> SETUP : enable / save ISL-ref
TEARDOWN --> TEARDOWN_OFFLINE : offline
TEARDOWN : enter / emit bfd-session remove

TEARDOWN_FAIL -> SETUP : enable / save ISL-ref
TEARDOWN_FAIL --> TEARDOWN_OFFLINE : offline

state OPERATIONAL {
    state linkStatusChoice <<choice>>

    [*] --> linkStatusChoice

    linkStatusChoice --> BFD_UP : [link is UP]
    linkStatusChoice --> BFD_DOWN : [else]

    BFD_UP -r-> BFD_DOWN : port-down
    BFD_UP : enter / emit bfd-up

    BFD_DOWN -l-> BFD_UP : port-up
    BFD_DOWN : enter / emit bfd-down
}
OPERATIONAL --> TEARDOWN : disable
OPERATIONAL --> OPERATIONAL_OFFLINE : offline
OPERATIONAL --> [*] : port-del / release BFD-discriminator
OPERATIONAL : enter / emit bfd-active
OPERATIONAL : exit / emit bfd-inactive
OPERATIONAL : exit / emit bfd-kill

OPERATIONAL_OFFLINE --> OPERATIONAL : online
OPERATIONAL_OFFLINE --> TEARDOWN_OFFLINE : disable

@enduml
