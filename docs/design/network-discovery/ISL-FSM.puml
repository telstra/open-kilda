Internal data:
* endpoint-A
* endpoint-B
* endpoint-A-up
* endpoint-B-up

Input signals:
* isl-up
* isl-down
* isl-move

Output signals:
* bisl-up (notify BFD-port, notify reroute)
* bisl-down (notify reroute)
* bisl-bfd-enable
* bisl-bfd-disable
* isl-move

@startuml
title ISL FSM

[*] --> DOWN : history [history-down]
[*] --> DOWN : isl-up
[*] --> UP : history [history-up]
[*] --> MOVED : history [history-moved]

state upAttempt <<choice>>
state deleteAttempt <<choice>>
deleteAttempt --> DELETED : [endpoint-(A&B)-down]

DOWN --> upAttempt : isl-up / set endpoint-(A||B)-up = true
DOWN --> MOVED : isl-move
DOWN : enter / persist DB state
DOWN : isl-down / set endpoint-(A||B)-up = false
DOWN : isl-down / persist DB state
DOWN -> deleteAttempt : isl-remove

upAttempt --> UP : [endpoint-(A&&B)-up]
upAttempt --> DOWN : [endpoint-(A||B)-down]

UP --> DOWN : isl-down
UP --> MOVED : isl-move
UP : enter / persist DB state
UP : enter / emit bisl-up
UP : enter [bfd-up && global-bfd-up] / emit bisl-bfd-enable
UP : exit / set endpoint-(A|B)-up = true
UP : exit / persist DB state
UP : exit [physical-down] / raise ISL(uni) cost
UP : exit / emit bisl-down
UP : bfd-update [bfd-up] / emit bisl-bfd-enable
UP : bfd-update [bfd-down] / emit bisl-bfd-disable

MOVED --> upAttempt : isl-up / set endpoint-(A|B)-up = true
MOVED --> deleteAttempt : isl-remove
MOVED : enter / persist DB state
MOVED : enter / emit isl-move
MOVED : enter / set endpoint-(A|B)-up = false
MOVED : isl-down / set endpoint-(A|B)-up = false
MOVED : isl-down / persist DB state

DELETED -> [*]
@enduml
