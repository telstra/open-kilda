plugins {
    id "org.springframework.boot" version "3.2.0"
}

configurations {
    // This conflicts with spring-boot-starter-log4j2
    implementation.exclude module: "spring-boot-starter-logging"
}
compileJava.options.compilerArgs += "-Amapstruct.unmappedTargetPolicy=ERROR"

description = "server42-control-storm-stub"

configurations.configureEach {
    //LoggerFactory is not a Logback LoggerContext but Logback is on the classpath. Either remove Logback or the competing implementation
    exclude group: "ch.qos.logback", module: "logback-classic"
    exclude group: "ch.qos.logback", module: "logback-core"
}

dependencies {
    implementation(platform("org.springframework:spring-framework-bom:6.0.6"))
    implementation(platform("org.springframework.boot:spring-boot-dependencies:3.1.0"))

    implementation(project(":server42-control-messaging"))
    implementation(project(":server42-messaging"))

    implementation("org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0")
    implementation("io.swagger.core.v3:swagger-core:2.2.19")
    implementation("joda-time:joda-time:2.10.13")
    implementation("io.micrometer:micrometer-core:1.9.2")
    implementation("io.micrometer:micrometer-registry-prometheus:1.9.2")

    implementation("com.fasterxml.jackson.core:jackson-core:2.16.1")
    implementation("com.fasterxml.jackson.core:jackson-annotations:2.16.1")
    implementation("com.fasterxml.jackson.core:jackson-databind:2.16.1")
    implementation("com.fasterxml.jackson.datatype:jackson-datatype-joda")

    implementation("org.springframework.boot:spring-boot-starter")
    implementation("org.springframework.boot:spring-boot-starter-actuator")
    implementation("org.springframework.boot:spring-boot-starter-log4j2")
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("org.springframework.kafka:spring-kafka:3.1.0")
    implementation("org.apache.kafka:kafka-clients")
    implementation("org.apache.kafka:kafka_2.12:3.6.1") {
        exclude group: "org.slf4j", module: "slf4j-log4j12"
        exclude group: "log4j", module: "log4j"
    }

    runtimeOnly("org.springframework.boot:spring-boot-devtools")

    testImplementation("org.springframework.boot:spring-boot-starter-test")
    testImplementation("org.springframework.kafka:spring-kafka-test:3.1.0")

    implementation("org.mapstruct:mapstruct")
    implementation("org.mapstruct:mapstruct-processor")
    annotationProcessor("org.mapstruct:mapstruct-processor")

    compileOnly("org.projectlombok:lombok")
    testCompileOnly("org.projectlombok:lombok")
    annotationProcessor("org.projectlombok:lombok")
    testAnnotationProcessor("org.projectlombok:lombok")
    annotationProcessor("org.projectlombok:lombok-mapstruct-binding")
    testAnnotationProcessor("org.projectlombok:lombok-mapstruct-binding")
}

bootJar {
    mainClass = "org.openkilda.server42.control.stormstub.StubApplication"
    archiveFileName = "${archivesBaseName}.${archiveExtension.get()}"
}

bootJar.dependsOn generateVersionTxt
