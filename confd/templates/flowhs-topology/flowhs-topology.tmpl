# Generated by confd.
# Do not change this file, all changes will be lost. Change corresponding template.

# topology configuration
config:
  topology.parallelism: {{ getv "/kilda_storm_flow_hs_parallelism" }}
  topology.workers: {{ getv "/kilda_storm_flowhs_workers" }}
  topology.spouts.parallelism: {{ getv "/kilda_storm_spout_parallelism" }}

# spout definitions
spouts:
  - id: "coordinator.spout"
    parallelism: 1
  - id: "zookeeper.spout"
    parallelism: 1
  - id: "FLOW_SPOUT"
    parallelism: {{ getv "/kilda_storm_spout_parallelism" }}
    properties:
      # The ratio of FLOW_SPOUT max pending to FLOW_xxx_HUB parallelism defines backpressure for H&S hubs.
      #
      # Experimentally determined that optimal backpressure for simultaneous reroutes is archived when
      # the number of FLOW_SPOUT tasks multiplied by the "max.spout.pending" is
      # between one-half (1/2) and three-fourths (3/4) of the number of FLOW_xxx_HUB tasks.
      #
      # E.g. FLOW_SPOUT parallelism = 4, max.spout.pending = 12 gives 48 in-flight tuples from FLOW_SPOUT side
      #      FLOW_REROUTE_HUB parallelism = 4 * 16 gives 64 tasks.
      #
      - name: "max.spout.pending"
        value: {{ div (mul (atoi (getv "/kilda_storm_flow_hs_reroute_hub_count_multiplier")) 3) 4 }}

# bolt definitions
bolts:
  - id: "zookeeper.bolt"
    parallelism: 1
  - id: "FLOW_REROUTE_HUB"
    parallelism: {{ mul (atoi (getv "/kilda_storm_flow_hs_parallelism")) (atoi (getv "/kilda_storm_flow_hs_reroute_hub_count_multiplier")) }}
    # Speaker workers are shared between hubs, but reroute hub uses more workers than other hubs.
    # That is why we need to increase parallelism of speaker worker at least to flow reroute parallelism
  - id: "SPEAKER_WORKER"
    parallelism: {{ mul (atoi (getv "/kilda_storm_flow_hs_parallelism")) (atoi (getv "/kilda_storm_flow_hs_reroute_hub_count_multiplier")) }}
  - id: "FLOW_VALIDATION_SPEAKER_WORKER"
    parallelism: {{ getv "/kilda_storm_flow_hs_validation_worker_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "FLOW_CREATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_create_hub_parallelism" }}
  - id: "FLOW_UPDATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_update_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "FLOW_DELETE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_delete_hub_parallelism" }}
  - id: "FLOW_SYNC_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_sync_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "FLOW_VALIDATION_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_validation_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "FLOW_SWAP_ENDPOINTS_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_swap_endpoint_hub_parallelism" }}
  - id: "FLOW_CREATE_MIRROR_POINT_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_create_mirror_hub_parallelism" }}
  - id: "FLOW_DELETE_MIRROR_POINT_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_flow_delete_mirror_hub_parallelism" }}
  - id: "YFLOW_CREATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_create_hub_parallelism" }}
  - id: "YFLOW_UPDATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_update_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "YFLOW_DELETE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_delete_hub_parallelism" }}
  - id: "YFLOW_SYNC_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_sync_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "YFLOW_VALIDATION_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_validation_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "YFLOW_REROUTE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_reroute_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "YFLOW_PATH_SWAP_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_path_swap_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "YFLOW_READ_BOLT"
    parallelism: {{ getv "/kilda_storm_flow_hs_y_flow_read_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_CREATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_create_hub_parallelism" }}
  - id: "HA_FLOW_UPDATE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_update_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_DELETE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_delete_hub_parallelism" }}
  - id: "HA_FLOW_SYNC_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_sync_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_VALIDATION_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_validation_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_REROUTE_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_reroute_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_PATH_SWAP_HUB"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_path_swap_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HA_FLOW_READ_BOLT"
    parallelism: {{ getv "/kilda_storm_flow_hs_ha_flow_read_hub_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "HISTORY_BOLT"
    parallelism: {{ getv "/kilda_storm_flow_hs_history_bolt_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "FLOW_ROUTER_BOLT"
    parallelism: {{ getv "/kilda_storm_flow_hs_router_bolt_parallelism" }}
    numTasks: {{ getv "/kilda_storm_flow_hs_num_tasks" }}
  - id: "METRICS_BOLT"
    parallelism: {{ getv "/kilda_storm_flow_hs_metrics_bolt_parallelism" }}
  - id: "NB_RESPONSE_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_nb_response_sender_parallelism" }}
  - id: "REROUTE_RESPONSE_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_reroute_response_sender_parallelism" }}
  - id: "SERVER42_CONTROL_TOPOLOGY_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_server42_control_sender_parallelism" }}
  - id: "SPEAKER_DUMP_REQUEST_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_dump_request_sender_parallelism" }}
  - id: "STATS_TOPOLOGY_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_stats_sender_parallelism" }}
  - id: "FLOW_PING_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_ping_sender_parallelism" }}
  - id: "FLOW_MONITORING_TOPOLOGY_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_monitoring_sender_parallelism" }}
  - id: "SPEAKER_REQUEST_SENDER"
    parallelism: {{ getv "/kilda_storm_flow_hs_speaker_request_sender_parallelism" }}
